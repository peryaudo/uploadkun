<html>
	<head>
		<title>upload-kun</title>
	</head>
	<body>
		<button type="button" id="allow-access">Allow access to the directory...</button>
		<script>
			var rootDirHandle;
			async function getHandleForLocation(entry, loc) {
				for (let i = 0; i < loc.length; i++) {
					if (i === loc.length - 1) {
						entry = await entry.getFileHandle(loc[i]);
					} else {
						entry = await entry.getDirectoryHandle(loc[i]);
					}
					if (!entry) {
						return null;
					}
				}
				return entry;
			}
			async function uploadFile(loc) {
				const entry = await getHandleForLocation(rootDirHandle, loc.slice(1));
				const file = await entry.getFile();
				const formData = new FormData();
				formData.append('f', file);
				formData.append('loc', JSON.stringify(loc));
				await fetch('/uploadFile', {
					method: 'PUT',
					body: formData
				});
			}
			async function getDirList(entry) {
				const result = {'kind': entry.kind, 'name': entry.name};
				if (entry.kind == 'directory') {
					result['entries'] = [];
					for await (const subEntry of entry.values()) {
						result['entries'].push(await getDirList(subEntry));
					}
				} else if (entry.kind == 'file') {
					const file = await entry.getFile();
					result['size'] = file.size;
					result['lastModified'] = Math.floor(file.lastModified / 1000);
				}
				return result;
			}
			async function pollFileRequest() {
				let response = await fetch('/pollFileRequest');
				if (response.status === 502) {
					await pollFileRequest();
				} else if (response.status === 200) {
					let respJson = await response.json();
					uploadFile(respJson['location']);
					await pollFileRequest();
				} else {
					console.log(response.statusText);
				}

			}
			document.getElementById("allow-access").addEventListener('click', async () => {
				rootDirHandle = await window.showDirectoryPicker();
				const dirList = await getDirList(rootDirHandle);
				await fetch('/notifyEntries', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(dirList)
				});
			});
			pollFileRequest();
		</script>
	</body>
</html>

